
/* jshint esversion: 6 */
;
/* 上面已经引入了 获取价格模块 mtGetPriceAndStock,以及 价格比较模块 PriceComparer。
  那么，这个文件要做的就是，
  1 在价格获取页面，就获取并存储价格。
  2 在特定的需要对比价格的页面，就生成对比价格功能UI,以便生成价格对比表格
*/
if(location.href.indexOf("https://dabao.meituan.com/trippackage/api/v2/deal/") > -1){
  mtGetPriceAndStock.init();
}else{
  // 这里必须要引入对比价格的数组文件  mtGetPriceCompare.hotel.js 来代替下面的 CMP
  // const CMP = {
  //   // 显示顺序
  //   seq: ["富力岭南花园温泉度假山庄"],
  //   "水榭假日公寓":{
  //     name:"水榭假日公寓",
  //     spus:{"55948670":"Hi", "38076076":"海湾半岛度假公寓","46232940":"融创海湾海景公寓"},
  //     groups: [
  //       [["577529","873715"],["39844073","51612796"],1],
  //       [["856704","886041"],["39844073","51612796"],1],
  //       [["856710","1021820"],["39844073","51612796"],1],
  //       [["856733","1315400"],["39844073","51612796"],1],
  //       [["856720","1021902"],["39844073","51612796"],1],
  //       [["856735","1315398"],["39844073","51612796"],1],
  //     ]
  //   }
  // };

  function getFormatedDate(dateObject) {
    var nowDate = dateObject;
    var year = nowDate.getFullYear();
    var month = nowDate.getMonth() + 1 < 10 ? "0" + (nowDate.getMonth() + 1) : nowDate.getMonth() + 1;
    var date = nowDate.getDate() < 10 ? "0" + nowDate.getDate() : nowDate.getDate();
    return year + "-" + month + "-" + date;
  };
  // 对价产品列表
  function makeCmpProductsUl(){
    let html = `
      <div id="left" :class="leftToggle">
        <div class="innerToolbar">
          <input type="date" v-model="date" v-on:change="logdate">
          <input type="text" v-model="keyword" @input="filterProducts" placeholder="搜索"/>
          <i id="leftControl" style="font-size:2em;" :class="leftControlClass" @click="toggleLeft"></i>
        </div>
        <ul id="cmpProjectsUl">
          <li class="collapseLi" v-for="name,index in liNames">
            <input type="radio" :id="name+index" :value="name" v-model="projectName">
            <label :for="name+index" @click="toggleLi">
              <span>{{name}}</span>
              <i @click="compare" class="iconButton icon-table"></i>
              <i @click="shareProject" class="iconButton icon-share"></i>
            </label>
            <span name="pnsLink">
              <a v-for="dealid in Object.keys(dataObj[name].spus)" target="_blank" :href="getHref(dealid)" :title="dealid">{{dataObj[name].spus[dealid]}}</a>
            </span>
          </li>
        </ul>
      </div>
      <div id="priceTable"></div>`;
    document.getElementById("showPriceTable").innerHTML = html;
    new Vue({
      el: "#left",
      data: {
        projectName: '',
        keyword: "",
        liNames: CMP.seq,
        dataObj: CMP,
        date: getFormatedDate(new Date(new Date().setDate(new Date().getDate()+5))),
        leftToggle: "",
        leftControlClass: "icon-doubleleft"
      },
      methods: {
        filterProducts: function(){
          let filted = fuzzy.filter(this.keyword, this.dataObj.seq, {});
          this.liNames = filted.map((item)=>{return item.original;});
        },
        getHref: function(dealid){
          return `https://dabao.meituan.com/trippackage/api/v2/deal/${dealid}/packages?dealId=${dealid}&client=app&startDate=${this.date}`;
        },
        logdate: function(){
          console.log(this.date);
        },
        compare: function(){
          setTimeout(() => {
            doCompare(this.projectName);
          }, 100);
          
        },
        toggleLi: function(e){
          let dad = e.target.parentElement.parentElement;
          if(dad.getAttribute("class") == "expandLi"){
            dad.setAttribute("class","collapseLi");
          }else{
            dad.setAttribute("class","expandLi");
          }
        },
        shareProject: function(){
          setTimeout(() => {
            dialogVue.shareCode(JSON.stringify(this.dataObj[this.projectName]));
          }, 100);
        },
        toggleLeft: function(){
          if(this.leftToggle){
            this.leftToggle = "";
            this.leftControlClass = "icon-doubleleft";
          }else{
            this.leftToggle = "leftHide";
            this.leftControlClass = "icon-doubleright"
          }
        }
      }
    });
  }
  makeCmpProductsUl();

  //下面是对价功能
  function getInitData(dealIdArr, pns){
    return new Promise((resolve,reject)=>{
      let obj = {};
      dealIdArr.map(item=>{
        let tmp = pns[item];
        tmp.seq.map(item1=>{
          obj[item1] = {
            "dealid": item,
            "title": tmp[item1].packageTitle,
            "price": tmp[item1].price.map(v=>{
              let promo = tmp[item1].promoText != undefined ? parseInt(tmp[item1].promoText.match(/\d{1,4}/g)[0]) : 0;
              return v&&(v.stock>0) ? (v.price / 100 - promo) : 0;
            })
          };
        });
      });
      resolve(obj);
    });
  }
  // 检验项目有效性，看看是否所有的套餐都可用
  function validProject(compareName, pns){
    let 
      name = CMP[compareName].name,
      spus = CMP[compareName].spus,
      groups = CMP[compareName].groups,
      validGroups = [],
      invalidGroups = [];
    let 
      tmpPackageGroup = [],
      tmpDealGroup = [];
    for(let i in groups){
      tmpInfo = '';
      tmpPackageGroup = [];
      tmpDealGroup = [];
      for(let j in groups[i][1]){
        if(pns[groups[i][1][j]][groups[i][0][j]]){
          tmpPackageGroup.push(groups[i][0][j]);
          tmpDealGroup.push(groups[i][1][j]);
        }else{
          invalidGroups.push(groups[i][0][j]);
        }
      }
      validGroups.push([tmpPackageGroup, tmpDealGroup, groups[i][2]]);
    }
    // 这里还需要调整，完整显示无效套餐具体信息
    if(invalidGroups.length){
      dialogVue.shareCode("以下套餐无效，建议换个日期，或者需要修改项目！！！\n"+invalidGroups.toString());      
    }
    return {
      name: name,
      spus: spus,
      groups: validGroups
    };

  }

  async function doCompare(compareName){
    let pns = GM_getValue("PNS",{});
    // let cmpObj = CMP[compareName];
    let cmpObj = validProject(compareName, pns);
    let pricedata = await getInitData(Object.keys(cmpObj.spus), pns);
    console.log(pricedata);
    PriceComparer.init(pricedata);
    // 先清空内容
    document.getElementById("priceTable").innerHTML = "";
    let tableid = PriceComparer.showTableHead("#priceTable", 70, compareName);
    for(let i in cmpObj.groups){
      let compareResult = await PriceComparer.reconstructPriceJson(cmpObj.groups[i][0], cmpObj.groups[i][2]||1);
      PriceComparer.showCompareResult(tableid, compareResult, cmpObj.spus, cmpObj.groups[i][2]||1);
    }
  }
  // doCompare("惠州十里银滩");

}

