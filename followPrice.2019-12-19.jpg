;;var Follow=(function(){let O={};O.html=`<div id="followPackage"class="innerToolbar"><i class="iconButton icon-unordered-list"@click="findAmuyunProduct"title="阿目云所有套餐"></i><i class="textButton"@click="toAmuyun":title="packageTitle"name="followPricePackageCalendar">{{packageTitle}}</i><input v-model="startDate"type="date"name="startDate"class="inputMedium"@change="startDateChange"><input v-model="endDate"type="date"name="endDate"class="inputMedium"@change="endDateChange"><i v-for="w,index in weekday"class="textButton"><input:checked="w":id="'weekday'+index"@change="weekdaySelect"type="checkbox":value="index"name="followWeekDay"/><label:for="'weekday'+index">{{weekdayName[index]}}</label></i></div><div id="dataBlock"><div id="spuName"><b>日期</b><b>利润</b><b v-for="name in spuNames":title="name">{{name}}</b><b><button@click="openSyncPage">同步</button></b><b><button>重置</button></b></div><div id="tar"><!--日期部分--><div class="priceContainer date"><b v-for="d,index in dateArray"><label:data-weekday="new Date(d).getDay()":data-value="d":data-index="index"@click="seletctSelf"name="date">{{d.slice(5)}}<br/>{{weekday[new Date(d).getDay()]}}</label></b></div><!--利润部分--><div class="priceContainer profit"><b v-for="d,index in dateArray"class="dateGrid":data-profitable="profit[index]>0?1:0"name="profit"><small>{{profit[index]}}</small></b></div><!--我们价格--><div class="priceContainer"name="hiPrice"><input type="text"v-for="d,dindex in hiPrice":data-raw="hiPriceRaw[dindex].price":data-index="dindex":value="d.price":data-cheap="d.low?'cheap':'expensive'":data-change="priceFlag[dindex]"@input="changePrice"max=99999 min=0></div><!--对手的价格--><div v-for="baga,index in bagaArray"class="priceContainer bagaPrice"name="bagaPrice"><b v-for="d,index1 in baga"><input type="radio":name="'price'+index1":id="'price'+index+index1":value="d.price":data-cheap="d.low?'cheap':'expensive'":data-index="index1"@change="followPrice"/><label:for="'price'+index+index1"v-if="d"name="bagaPrice">{{d.price}}</label></b></div><!--库存部分，先隐藏<div class="priceContainer"><b v-for="d,index in hiStock"class="priceGrid"><input type="text":data-raw="hiStockRaw[index].stock":data-index="index":value="d":data-change="stockFlag[index]"@input="changeStock"max=100 min=0></b></div>--><!--操作部分：保存，关房，重置，关房后面再做--><!--库存部分，先隐藏<div id="toggleStock"class="priceContainer"><b v-for="d,index in dateArray"><i:data-index="index"@click="toggleStock"name="toggleStock"class="textButton">关</i></b></div>--><div id="syncPNS"class="priceContainer"><b v-for="d,index in dateArray"><input:data-index="index"@click="syncPNS"name="syncPNS"value="保存"disabled="disabled"type="button"/></b></div><div id="reset"class="priceContainer"><b v-for="d,index in dateArray"><input:data-index="index"@click="reset"name="reset"value="重置"type="button"/></b></div></div></div><!--批量操作部分--><div id="opt"><fieldset class="optField"><legend>批量跟价</legend><button@click="clearBagaSelected"name="clearBagaSelected">清空多选</button><button@click="followBagaPrice"name="followBagaPrice">多选跟价</button></fieldset><fieldset class="optField"><legend>批量操作</legend><!--<button@click="multiCloseStock"name="multiCloseStock">关房</button>--><button@click="multiResetPrice"name="multiResetPrice">重置</button><button@click="multiSyncPNS"name="multiSyncPNS">保存</button><button@click="clearDateSelected"name="clearDateSelected">清空日期</button><span name="operspan"><button@click="multiAddPrice"name="multiAddPrice">批量加价</button><input type="number"name="multiAddPrice"v-model.number="addPrice"max=1000 min=-1000 class="inputShort"><span>元</span></span></fieldset></div>`;O.prepareData=function(){return new Promise(async(resolve,reject)=>{let followJson=GM_getValue("FOLLOWPRICE",{});let pns=GM_getValue("PNS",{});let priceData=await GetPriceAndStock.givePpidArrayGetPkgsPNS(followJson.spus);PriceComparer.init(priceData);let compareResult=await PriceComparer.reconstructPriceJson(followJson.packages);resolve(compareResult)})};O.updateFollowPriceProject=function(){let checkboxs=Nacl.qs("#showPriceTable input[type='checkbox']:checked");if(checkboxs.length<2){dialogVue.showInfo("没有选好对价套餐，再来~~  ( →_→)","warning",1);return false}let project={spuNames:[],spus:[],packages:[]};checkboxs.forEach((item)=>{let a=item.value.split("|");project.spuNames.push(a[0]);project.spus.push(a[1]);project.packages.push(a[2])});project['packageName']=checkboxs[0].parentElement.nextElementSibling.textContent;GM_setValue("FOLLOWPRICE","");GM_setValue("FOLLOWPRICE",project)};O.init=async function(){Nacl.q('#followPrice').innerHTML=O.html;var packageVue=new Vue({el:"#followPackage",data:{spuId:"",amuyunPackageId:"",packageTitle:"价格日历",startDate:Nacl.formatDate(new Date()),endDate:Nacl.formatDate(new Date(),15),weekday:[0,0,0,0,0,0,0],weekdayName:["日","一","二","三","四","五","六"]},methods:{toAmuyun:function(){window.open(`http:},findAmuyunProduct:function(){window.open(`http:"blank")},startDateChange:function(){if(this.startDate>this.endDate){this.endDate=this.startDate}},endDateChange:function(){if(this.endDate<this.startDate){this.endDate=this.startDate;dialogVue.showInfo("截止日期不能早于开始日期","warning",1)}},weekdaySelect:function(e){this.weekday[e.target.value]=!this.weekday[e.target.value];Nacl.qs(`#tar label[name='date'][data-weekday='${e.target.value}']`).forEach((item)=>{if(this.startDate<=item.dataset.value&&item.dataset.value<=this.endDate){let isSelected=item.getAttribute("class");if(this.weekday[e.target.value]){if(!isSelected){item.setAttribute("class","dragSelected");DragSelect.selectedList.push(item)}}else{if(isSelected){item.removeAttribute("class");DragSelect.selectedList=DragSelect.selectedList.filter((item1)=>{return item1.dataset.index!=item.dataset.index||item1.name=="bagaPrice"})}}}})}}});var spuVue=new Vue({el:"#spuName",data:{spuNames:["Hi","对手"]},methods:{updateData:function(data){Vue.set(this,"spuNames",data)},openSyncPage:function(){syncAmuyun.synchro(packageVue.amuyunPackageId,config.platformNameEn)}}});var priceVue=new Vue({el:"#tar",data:{weekday:["日","一","二","三","四","五","六"],dateArray:Array(90).fill(null).map((i,j)=>{return Nacl.formatDate(new Date(),j)}),hiPrice:Array(90).fill({price:0,low:true}),profit:Array(90).fill(null),calendar:null,platformRate:0.0,hiPriceRaw:Array(90).fill({price:0,low:true}),priceFlag:Array(90).fill(0),bagaArray:[Array(90).fill({price:0,low:true})]},methods:{seletctSelf:function(e){let index=e.target.dataset.index;let label=Nacl.q(`label[name='date'][data-index='${index}']`);let isSelected=label.getAttribute("class");if(isSelected){label.removeAttribute("class");DragSelect.selectedList=DragSelect.selectedList.filter((item)=>{return item.dataset.index!=index||item.name=="bagaPrice"})}else{label.setAttribute("class","dragSelected");DragSelect.selectedList.push(label)}},updateProfit:function(index){try{if(this.hiPrice[index]&&this.hiPrice[index].price&&this.calendar&&this.calendar[this.dateArray[index]]){let profit=this.hiPrice[index].price*(1-this.platformRate)-this.calendar[this.dateArray[index]].data.price;Vue.set(this.profit,index,profit.toFixed(2))}else{Vue.set(this.profit,index,null)}}catch(error){console.log(error)}},enableSaveButton:function(index){Nacl.q(`input[name='syncPNS'][data-index='${index}']`).setAttribute("class","textButton");if(this.calendar&&this.calendar[this.dateArray[index]].platform_data.sell){if(this.hiPrice[index].price==parseInt(this.calendar[this.dateArray[index]].platform_data.sell)){Nacl.q(`input[name='syncPNS'][data-index='${index}']`).setAttribute("disabled","disabled")}else{Nacl.q(`input[name='syncPNS'][data-index='${index}']`).removeAttribute("disabled")}}else{console.log("还没有价格回来")}},isPriceChange:function(index){let flag=this.hiPrice[index].price==this.hiPriceRaw[index].price?0:1;Vue.set(this.priceFlag,index,flag);this.updateProfit(index);this.enableSaveButton(index)},changePrice:function(e){let index=e.target.dataset.index;this.hiPrice[index].price=e.target.value;this.isPriceChange(index)},followPrice:function(e){let index=e.target.dataset.index;this.hiPrice[index].price=parseInt(e.target.value);this.isPriceChange(index)},isStockChange:function(index){let flag=this.hiStock[index]==this.hiStockRaw[index]?0:1;Vue.set(this.stockFlag,index,flag)},changeStock:function(e){let index=e.target.dataset.index;this.hiStock[index]=e.target.value;this.isStockChange(index)},toggleStock:function(e){let index=e.target.dataset.index;if(this.hiStock[index]){Vue.set(this.hiStock,index,0);e.target.textContent="开"}else{Vue.set(this.hiStock,index,5);e.target.textContent="关"}this.isStockChange(index)},syncPNS:function(e){if(!packageVue.amuyunPackageId){dialogVue.showInfo("[ 子产品ID ] 没有哦~~","error")}let index=e.target.dataset.index;let dataJson={product_price_status:"1",profit_val:this.profit[index],product_id:packageVue.amuyunPackageId,platformName:config.platformNameEn,date:this.dateArray[0].slice(0,-3),pro_date:this.dateArray[index]};syncAmuyun.setPlatformPrice(dataJson,function(data){if(!data.response&&data.finalUrl=="http://erp.himudidi.com/public/login.html"){dialogVue.showInfo("╮(╯▽╰)╭  你还没有登录阿目云吧?","error");return false}if(data.response.status){e.target.setAttribute("class","textButton success");console.log(data.response)}else{e.target.setAttribute("class","textButton fail")}})},reset:function(e){let index=e.target.dataset.index;this.hiPrice[index]=Nacl.cloneJsonObject(this.hiPriceRaw[index]);this.isPriceChange(index);let radioName='price'+index;Nacl.qs(`input[name='${radioName}']`).forEach(i=>{i.checked=false})},updateData:function(kvJson){this.resetVue();for(let j in kvJson){this[j]=kvJson[j]}this.profit.forEach((item,index)=>{this.updateProfit(index)})},resetVue:function(){Vue.set(this,"dateArray",Array(90).fill(null).map((i,j)=>{return Nacl.formatDate(new Date(),j)}));Vue.set(this,"priceFlag",Array(90).fill(0));Nacl.qs("#tar input[type='radio']").forEach((item)=>{item.checked=false});Nacl.qs("#tar input[name='syncPNS']:enabled").forEach(item=>{item.setAttribute("disabled","disabled")})}}});var optVue=new Vue({el:"#opt",data:{addPrice:0},methods:{clearBagaSelected:function(){let tmpList=[];DragSelect.selectedList.map((item,index)=>{if(item.getAttribute("name")=="bagaPrice"){item.setAttribute("class","")}else{tmpList.push(item)}});DragSelect.selectedList=tmpList},followBagaPrice:function(){DragSelect.selectedList.map((item)=>{if(item.getAttribute("name")=="bagaPrice"){item.click()}})},clearDateSelected:function(){tmpList=[];DragSelect.selectedList.map((item,index)=>{if(item.getAttribute("name")=="date"){item.setAttribute("class","")}else{tmpList.push(item)}});DragSelect.selectedList=tmpList},multiResetPrice:function(){DragSelect.selectedList.map((item)=>{if(item.getAttribute("name")=="date"){Nacl.q(`input[name="reset"][data-index="${item.dataset.index}"]`).click()}})},multiCloseStock:function(){DragSelect.selectedList.map((item)=>{if(item.getAttribute("name")=="date"){Nacl.q(`input[name="toggleStock"][data-index="${item.dataset.index}"]`).click()}})},multiSyncPNS:function(){DragSelect.selectedList.map((item)=>{if(item.getAttribute("name")=="date"){Nacl.q(`input[name="syncPNS"][data-index="${item.dataset.index}"]`).click()}})},multiAddPrice:function(){DragSelect.selectedList.map((item)=>{if(item.getAttribute("name")=="date"){Vue.set(priceVue.hiPrice,item.dataset.index,{price:priceVue.hiPrice[item.dataset.index].price+this.addPrice,low:priceVue.hiPrice[item.dataset.index].low});priceVue.isPriceChange(item.dataset.index)}})},reset:function(){this.clearBagaSelected();this.clearDateSelected()}}});function initDragSelect(){var checker=setInterval(()=>{let divCount=Nacl.qs("#reset input[name='reset']").length;if(divCount==priceVue.dateArray.length){clearInterval(checker);DragSelect.enable("#tar","#tar label[name='date'], #tar label[name='bagaPrice']","INPUT")}console.log('waiting ...')},300)}initDragSelect();GM_addValueChangeListener("FOLLOWPRICE",async function(name,oldValue,newValue,remote){if(remote||newValue==""){return false}try{let followDataJson=await O.prepareData();let bagaPrices=[];for(let i=1;i<followDataJson.length;i++){bagaPrices.push(followDataJson[i].cmpPrices)}let pns=GM_getValue("PNS",{});packageVue.spuId=pns[newValue.spus[0]].spuId||newValue.spus[0];let spuPackages=await productInfo.giveSpuIdGetSpuPackages(packageVue.spuId,1);let spuPackageId=await(()=>{return new Promise((resolve,reject)=>{let tmp=null;if(spuPackages.hasOwnProperty(newValue.packages[0])){tmp=spuPackages[newValue.packages[0]].spupkgId}else{for(let j in spuPackages){if(spuPackages[j].pkgTitle==newValue.packageName){tmp=spuPackages[j].spupkgId;newValue.packages[0]=j;break}else if(spuPackages[j].pkgTitle.length==newValue.packageName.length){if(spuPackages[j].pkgTitle.split("+").sort().join('')==newValue.packageName.split("+").sort().join('')){tmp=spuPackages[j].spupkgId;newValue.packages[0]=j;break}}}}resolve(tmp)})})();let amuyunPns=await syncAmuyun.getPns(spuPackageId);packageVue.amuyunPackageId=amuyunPns.product_id;packageVue.packageTitle=spuPackages[newValue.packages[0]].pkgTitle;spuVue.updateData(newValue.spuNames);priceVue.updateData({hiPrice:followDataJson[0].cmpPrices,hiPriceRaw:Nacl.cloneJsonObject(followDataJson[0].cmpPrices),calendar:amuyunPns.calendar,platformRate:amuyunPns.platform_rate/100,bagaArray:bagaPrices});optVue.reset()}catch(error){console.log(error);if(error.hasOwnProperty("errorType")){dialogVue.showInfo(error.message,"error",6)}else{dialogVue.showInfo("不知道出了什么问题，联系庄解决！<br>"+"followPrice:GM_addValueChangeListener followPrice<br>"+error,"error")}}Nacl.q("#nav span[name='followPrice']").click()})};return O})();;